{
  "whens" : {
    "envelope" : [
      {
        "expr" : {
          "left" : {"section" : "envelope", "key" : "type", "type" : "reference"},
          "right" : {"type" : "string", "value" : "invoice"},
          "op" : "eq"
        }
      },
      {
        "expr" : {
          "left" : {"section" : "envelope", "key" : "parties.supplier.industry.list_id", "type" : "reference"},
          "right" : {"type" : "string", "value" : "ISIC"},
          "op" : "eq"
        }
      },
      {
        "expr" : {
          "left" : {"section" : "envelope", "key" : "parties.supplier.industry.value", "type" : "reference"},
          "right" : {"type" : "string", "value" : "G4711"},
          "op" : "eq"
        }
      }
    ],
    "item" : [
      {
        "expr" : {
          "left" : {"section" : "item", "key" : "classification.list_name", "type" : "reference"},
          "right" : {"type" : "string", "value" : "UNSPSC"},
          "op" : "eq"
        }
      },
      {
        "expr" : {
          "left" : {"section" : "item", "key" : "classification.value", "type" : "reference"},
          "right" : {"type" : "string", "value" : "506505"},
          "op" : "eq"
        }
      },
      {
        "expr" : {
          "left" : {"section" : "item", "key" : "quantity.value", "type" : "reference"},
          "right" : {"type" : "number", "value" : "0"},
          "op" : "gt"
        }
      }
    ]
  },
  "steps" : [
    {
      "name" : "require",
      "reference": {
        "package":"ca.qc.tax",
        "id":"station_distances",
        "version":"0.0.1",
        "name":"distances"
      },
      "indexes":[]
    },
    {
      "name" : "require",
      "reference": {
        "package":"ca.qc.tax",
        "id":"reductions_by_distance",
        "version":"0.0.1",
        "name":"reductions_by_distance"
      },
      "indexes":[]
    },
    {
      "table_name" : "sellers_distances",
      "columns" : [
        {
          "table" : {
            "section" : "table",
            "key" : "reductions_by_distance",
            "type" : "reference"
          },
          "sources" : [
            {"columns" : []}
          ]
        },
        {
          "table" : {
            "section" : "table",
            "key" : "distances",
            "type" : "reference"
          },
          "sources" : [
            {
              "name" : "seller_distance",
              "source" : "seller_distance",
              "whens" : [
                {
                  "left" : {"section" : "envelope", "key" : "parties.suppler.id.value", "type" : "reference"},
                  "right" : {"section" : "_local", "key" : "supplier_id", "type" : "reference"},
                  "op" : "eq"
                }
              ]
            }
          ]
        }
      ],
      "name" : "assemble"
    },
    {
      "name" : "refine",
      "table" : { "type" : "reference", "section" : "table", "key" : "sellers_distances" },
      "refined_name" : "sellers_reductions",
      "refinements" : [
        {
          "name" : "map",
          "assignment" : {
            "target" : "difference",
            "source" : {
              "type" : "function",
              "name" : "subtract",
              "args" : [
                { "type" : "reference", "section" : "_local", "key" : "distance" },
                { "type" : "reference", "section" : "_local", "key" : "seller_distance" }
              ]
            }
          }
        }
      ]
    },
    {
      "name" : "refine",
      "table" : { "type" : "reference", "section" : "table", "key" : "sellers_reductions" },
      "refined_name" : "applicable_sellers_reductions",
      "refinements" : [
        {
          "name" : "filter",
          "condition" : {
            "left"  : { "type" : "reference", "section" : "_local", "key" : "difference" },
            "right" : { "type" : "number", "value" : "0" },
            "op"    : "gte"
          }
        },
        {
          "name" : "map",
          "assignment" : {
            "target" : "min_difference",
            "source" : {
              "type" : "function",
              "name" : "min",
              "args" : [
                { "type" : "reference", "section" : "_local", "key" : "min_difference" },
                { "type" : "reference", "section" : "_local", "key" : "difference" }
              ]
            }
          }
        }
      ]
    },
    {
      "name" : "refine",
      "table" : { "type" : "reference", "section" : "table", "key" : "applicable_sellers_reductions" },
      "refined_name" : "final_sellers_reductions",
      "refinements" : [
        {
          "name" : "filter",
          "condition" : {
            "left"  : { "type" : "reference", "section" : "_local", "key" : "difference" },
            "right" : { "type" : "reference", "section" : "_local", "key" : "min_difference" },
            "op"    : "eq"
          }
        }
      ]
    },
    {
      "table_name": "item_reductions",
      "columns": [
        {
          "table": { "section": "table", "key": "items", "type": "reference"},
          "sources": [
            {
              "columns": ["id", "classification", "price"],
              "whens": [
                {
                  "left": {"section": "_local", "key": "classification.list_name", "type": "reference"},
                  "right": {"type": "string", "value": "UNSPSC"},
                  "op": "eq"
                },
                {
                  "left": {"section": "_local", "key": "classification.value", "type": "reference"},
                  "right": {"type": "string", "value": "506505"},
                  "op": "eq"
                }
              ]
            }
          ]
        },
        {
          "table": {"section": "table", "key": "final_sellers_reductions", "type": "reference"},
          "sources": [
            {"name": "reduction", "source": "reduction"}
          ]
        }
      ],
      "name": "assemble"
    },
    {
      "name" : "refine",
      "table" : { "type" : "reference", "section" : "table", "key" : "item_reductions" },
      "refined_name" : "applicable_reductions",
      "refinements" : [
        {
          "name" : "map",
          "assignment" : {
            "target" : "allowance.charge",
            "source" : { "type" : "string", "value" : "false" }
          }
        },
        {
          "name" : "map",
          "assignment" : {
            "target" : "allowance.amount.value",
            "source" : {
              "type" : "function",
              "name" : "multiply",
              "args" : [
                { "type" : "reference", "section" : "_local", "key" : "price.value" },
                { "type" : "reference", "section" : "_local", "key" : "reduction" }
              ]
            }
          }
        },
        {
          "name" : "map",
          "assignment" : {
            "target" : "allowance.amount.currency_code",
            "source" : { "type" : "reference", "section" : "_local", "key" : "price.currency_code" }
          }
        }
      ]
    },
    {
      "table": {"section": "table", "key": "items", "type": "reference"},
      "revisions": [
        {
          "op": "add",
          "source": {
            "column": "allowance",
            "table": {"section": "table", "key": "applicable_reductions", "type": "reference"}
          }
        }
      ],
      "name": "revise"
    }
  ]
}
